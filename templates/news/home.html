{% extends "base.html" %}

{% block title %}News - Home{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <!-- Filters Sidebar -->
    <div class="col-md-3">
      <div class="card mb-4">
        <div class="card-header">
          <h5>Filters</h5>
        </div>
        <div class="card-body">
          <form method="get" action="{% url 'news_home' %}">
            <!-- Source Filter -->
            <div class="mb-3">
              <label for="source" class="form-label">Source</label>
              <select name="source" id="source" class="form-select">
                <option value="">All Sources</option>
                {% for source in sources %}
                  <option value="{{ source.id }}" {% if current_source == source.id|stringformat:"s" %}selected{% endif %}>
                    {{ source.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Topic Filter -->
            <div class="mb-3">
              <label for="topic" class="form-label">Topic</label>
              <select name="topic" id="topic" class="form-select">
                <option value="">All Topics</option>
                {% for topic in topics %}
                  <option value="{{ topic.slug }}" {% if current_topic == topic.slug %}selected{% endif %}>
                    {{ topic.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Time Range Filter -->
            <div class="mb-3">
              <label for="days" class="form-label">Time Range</label>
              <select name="days" id="days" class="form-select">
                <option value="">All Time</option>
                <option value="1" {% if current_days == "1" %}selected{% endif %}>Today</option>
                <option value="7" {% if current_days == "7" %}selected{% endif %}>Last Week</option>
                <option value="30" {% if current_days == "30" %}selected{% endif %}>Last Month</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Articles List -->
    <div class="col-md-9">
      <h2 class="mb-4">
        {% if current_source or current_topic or current_days %}
          Filtered News
        {% elif user.is_authenticated %}
          Your Personalized News Feed
        {% else %}
          Latest News
        {% endif %}
      </h2>

      {% if not page_obj %}
        <div class="alert alert-info">No articles found matching your criteria.</div>
      {% endif %}

      <div class="row">
        {% for article in page_obj %}
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              {% if article.featured_image_url %}
                <img src="{{ article.featured_image_url }}" class="card-img-top" alt="{{ article.title }}">
              {% endif %}

              <div class="card-body">
                <h5 class="card-title">{{ article.title }}</h5>
                <h6 class="card-subtitle mb-2 text-muted">
                  <a href="{% url 'source_detail' article.source.id %}">{{ article.source.name }}</a> |
                  {{ article.publication_date|date:"M d, Y" }}
                </h6>

                {% if article.summary %}
                  <p class="card-text">{{ article.summary|truncatewords:30 }}</p>
                {% endif %}

                {% if article.bias_score is not None %}
                  <div class="mb-2">
                    <small class="text-muted">
                      Bias Score:
                      {% if article.bias_score < -0.5 %}
                        <span class="badge bg-primary">Left</span>
                      {% elif article.bias_score < -0.2 %}
                        <span class="badge bg-info">Lean Left</span>
                      {% elif article.bias_score < 0.2 %}
                        <span class="badge bg-secondary">Center</span>
                      {% elif article.bias_score < 0.5 %}
                        <span class="badge bg-warning">Lean Right</span>
                      {% else %}
                        <span class="badge bg-danger">Right</span>
                      {% endif %}
                    </small>
                  </div>
                {% endif %}

                <a href="{% url 'article_detail' article.id %}" class="btn btn-outline-primary">Read More</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if page_obj.has_other_pages %}
        <nav aria-label="Page navigation" class="mt-4">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item"><a class="page-link" href="?page=1{% if current_source %}&source={{ current_source }}{% endif %}{% if current_topic %}&topic={{ current_topic }}{% endif %}{% if current_days %}&days={{ current_days }}{% endif %}">First</a></li>
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if current_source %}&source={{ current_source }}{% endif %}{% if current_topic %}&topic={{ current_topic }}{% endif %}{% if current_days %}&days={{ current_days }}{% endif %}">Previous</a></li>
            {% else %}
              <li class="page-item disabled"><a class="page-link" href="#">First</a></li>
              <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
                <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}{% if current_source %}&source={{ current_source }}{% endif %}{% if current_topic %}&topic={{ current_topic }}{% endif %}{% if current_days %}&days={{ current_days }}{% endif %}">{{ num }}</a></li>
              {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if current_source %}&source={{ current_source }}{% endif %}{% if current_topic %}&topic={{ current_topic }}{% endif %}{% if current_days %}&days={{ current_days }}{% endif %}">Next</a></li>
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if current_source %}&source={{ current_source }}{% endif %}{% if current_topic %}&topic={{ current_topic }}{% endif %}{% if current_days %}&days={{ current_days }}{% endif %}">Last</a></li>
            {% else %}
              <li class="page-item disabled"><a class="page-link" href="#">Next</a></li>
              <li class="page-item disabled"><a class="page-link" href="#">Last</a></li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
{% extends "base.html" %}
{% load custom_filters %}

{% block title %}Model Comparison - VeriFact{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">Fake News Detection Model Comparison</h1>
  <p class="lead mb-4">
    This dashboard compares lightweight pre-trained models for fake news detection,
    showing the tradeoff between accuracy and computational resource usage.
  </p>

  <!-- Performance Summary Table -->
  <div class="card mb-5">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Model Performance Overview</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Model</th>
              <th>Accuracy</th>
              <th>F1 Score</th>
              <th>Processing Time</th>
              <th>Memory Usage</th>
            </tr>
          </thead>
          <tbody>
            {% for metric in model_metrics %}
              <tr>
                <td><strong>{{ metric.model_name }}</strong></td>
                <td>{{ metric.accuracy|floatformat:2 }}</td>
                <td>{{ metric.f1_score|floatformat:2 }}</td>
                <td>{{ metric.avg_processing_time|floatformat:2 }}s</td>
                <td>{{ metric.avg_memory_usage|floatformat:1 }} MB</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center">No model metrics available yet.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Visualization -->
  <div class="card mb-5">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Performance vs. Resource Usage</h5>
    </div>
    <div class="card-body">
      <p>
        This visualization shows the trade-off between model accuracy and resource requirements.
        The ideal model would be in the top-left corner (high accuracy, low resource usage).
      </p>

      <div id="perfChart" style="height: 400px; width: 100%;"></div>
    </div>
  </div>

  <!-- Model Recommendations -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Model Selection Recommendations</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">Best for Accuracy</h5>
              {% with best_accuracy=model_metrics|dictsort:"accuracy"|last %}
                {% if best_accuracy %}
                  <h6 class="card-subtitle mb-2 text-muted">{{ best_accuracy.model_name }}</h6>
                  <p class="card-text">
                    Accuracy: <strong>{{ best_accuracy.accuracy|floatformat:2 }}</strong><br>
                    Memory: {{ best_accuracy.avg_memory_usage|floatformat:1 }} MB
                  </p>
                  <p class="card-text">
                    Recommended when accuracy is your top priority.
                  </p>
                {% else %}
                  <p class="card-text">No model metrics available</p>
                {% endif %}
              {% endwith %}
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">Best for Resource Constraints</h5>
              {% with best_memory=model_metrics|dictsort:"avg_memory_usage"|first %}
                {% if best_memory %}
                  <h6 class="card-subtitle mb-2 text-muted">{{ best_memory.model_name }}</h6>
                  <p class="card-text">
                    Memory: <strong>{{ best_memory.avg_memory_usage|floatformat:1 }} MB</strong><br>
                    Accuracy: {{ best_memory.accuracy|floatformat:2 }}
                  </p>
                  <p class="card-text">
                    Ideal for resource-constrained environments like edge devices.
                  </p>
                {% else %}
                  <p class="card-text">No model metrics available</p>
                {% endif %}
              {% endwith %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Model data from context
    const modelData = [
      {% for metric in model_metrics %}
        {
          label: "{{ metric.model_name }}",
          accuracy: {{ metric.accuracy }},
          memory: {{ metric.avg_memory_usage }},
          time: {{ metric.avg_processing_time }}
        }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];

    if (modelData.length > 0) {
      // Create scatter plot
      const ctx = document.getElementById('perfChart').getContext('2d');
      const chart = new Chart(ctx, {
        type: 'bubble',
        data: {
          datasets: modelData.map((model, index) => ({
            label: model.label,
            data: [{
              x: model.memory,  // Memory usage (MB)
              y: model.accuracy, // Accuracy (0-1)
              r: model.time * 5  // Bubble size based on processing time
            }],
            backgroundColor: getColor(index, 0.5),
            borderColor: getColor(index, 1),
          }))
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: {
                display: true,
                text: 'Memory Usage (MB)'
              },
              min: 0
            },
            y: {
              title: {
                display: true,
                text: 'Accuracy'
              },
              min: 0.7,
              max: 1.0
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const model = modelData[context.datasetIndex];
                  return [
                    `Model: ${model.label}`,
                    `Accuracy: ${model.accuracy.toFixed(2)}`,
                    `Memory: ${model.memory.toFixed(1)} MB`,
                    `Processing Time: ${model.time.toFixed(2)}s`
                  ];
                }
              }
            }
          }
        }
      });
    }

    // Generate colors for the chart
    function getColor(index, alpha) {
      const colors = [
        `rgba(52, 152, 219, ${alpha})`,  // Blue
        `rgba(46, 204, 113, ${alpha})`,  // Green
        `rgba(155, 89, 182, ${alpha})`,  // Purple
        `rgba(241, 196, 15, ${alpha})`,  // Yellow
        `rgba(231, 76, 60, ${alpha})`    // Red
      ];
      return colors[index % colors.length];
    }
  });
</script>
{% endblock %}